length(unique(dat$schoolid))
dat$res1
dim(res1)
dim(dat$res1)
length(dat$res1)
res1mean <- tapply(dat$res1,dat$schoolid,mean,na.rm=T)
plot(res1mean)
plot(res1mean)
length(res1mean)
plot(dat$pred1, dat$res1)
plot(res1mean)
plot(dat$ses, dat$mathkind)
plot(dat$ses, dat$pred1)
plot(dat$ses, dat$mathkind)
plot(dat$ses, dat$pred1)
plot(dat$ses, dat$mathkind)
plot(dat$ses, dat$pred1)
dat %>% ggplot(aes(x = ses, y = mathkind)) + geom_smooth(method = "lm")
library(tidyverse)
dat %>% ggplot(aes(x = ses, y = mathkind)) + geom_smooth(method = "lm")
dat %>% ggplot(aes(x = ses, y = mathkind)) + geom_point()
dat %>% ggplot(aes(x = ses, y = mathkind)) + geom_point() + geom_smooth()
dat %>% ggplot(aes(x = ses, y = mathkind)) + geom_point() + geom_smooth(method = "lm")
plot(fit1)
plot(fit1)
hist(res1mean)
mean(res1mean)
res1mean
dat %>% filter(schoolid == 107)
dat %>% filter(schoolid == 107) %>% select(res1) %>% summarise(mean)
dat %>% filter(schoolid == 107) %>% select(res1) %>% summarise(mean(res1))
dat %>% filter(schoolid == 1) %>% select(res1) %>% summarise(mean(res1))
dta
library(foreign)
library(lme4)
library(lmerTest)
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 60),
tidy = TRUE, warning = FALSE)
# load data
cl <- read.dta("classroom.dta")
# convert IDs to factor
cols_factor <- c("classid", "schoolid", "childid")
cl[cols_factor] <- lapply(cl[cols_factor], factor)
length(unique(cl$ses))
hist(cl$ses)
cor(cl$ses, cl$mathkind)
cor(cl)
# unconditional means model
lme1 <- lmer(mathgain ~ (1 | schoolid), data = cl)
# log likelihood
logLik(lme1)
str(cl)
summary(lme1)
str(cl)
# unconditional means model
lme2 <- lmer(mathgain ~ (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme2)
summary(lme2)
?ranova
ranova(lme2)
lme3 <- lmer(mathgain ~  mathkind + (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme3)
# model fit
summary(lme3)
length(unique(cl$mathkind))
length(unique(cl$classid))
length(unique(cl$schoolid))
hist(cl$schoolid)
hist(cl$mathkind)
cor(cl$mathkind, cl$mathgain)
plot(cl$mathkind, cl$mathgain)
lme4 <- lmer(mathgain ~ mathkind + ses + (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme4)
summary(lme4)
?summary
tapply(cl$mathkind, index = 1, fun = mean)
tapply(cl$schoolid, $mathkind, cl$mathkind, fun = mean)
tapply(cl$schoolid, cl$mathkind, cl$mathkind, fun = mean)
tapply(cl$schoolid, cl$mathkind, mean)
tapply(cl$mathkind, cl$schoolid, mean)
boxplot(cl$mathkind)
boxplot(cl$mathkind, cl$schoolid)
boxplot(cl[ , c("mathkind", "schoolid")])
boxplot(cl[ , "schoolid"])
tapply(cl$schoolid, cl$mathkind, mean)
tapply(cl$mathkind, cl$schoolid, mean)
plot(tapply(cl$mathkind, cl$schoolid, mean))
plot(sort(tapply(cl$mathkind, cl$schoolid, mean)))
plot(sort(cl$mathkind))
plot(sort(tapply(cl$mathkind, cl$schoolid, mean)))
plot(sort(cl$mathkind))
library(dplyr)
# add variables
cl %>% group_by(schoolid) %>% summarise(ses_sch = mean(ses))
unique(cl$classid)
dim(cl)
ses_cls <- cl %>% group_by(schoolid, classid) %>% summarise(ses_cls = mean(ses))
dim(ses_cls)
head(ses_cls)
# add variables
ses_sch <- cl %>% group_by(schoolid) %>% summarise(ses_sch = mean(ses))
ses_cls <- cl %>% group_by(schoolid, classid) %>% summarise(ses_cls = mean(ses))
mk_sch <- cl %>% group_by(schoolid) %>% summarise(mk_sch = mean(mathkind))
mk_cls <- cl %>%
group_by(schoolid, classid) %>%
summarise(mk_cls = mean(mathkind))
dim(mk_cls)
head(mk_class)
head(mk_cls)
dim(cl)
?join
cl %>% inner_join(ses_sch) %>%
inner_join(ses_cls) %>%
inner_join(mk_sch) %>%
inner_join(mk_cls)
# add columns to main data
cl_new <- cl %>% inner_join(ses_sch) %>%
inner_join(ses_cls) %>%
inner_join(mk_sch) %>%
inner_join(mk_cls)
dim(cl_new)
colnames(cl_new)
# run model
lme5 <- lmer(mathgain ~ mathkind + ses + ses_sch + ses_cls + mk_sch + mk_cls +
(1 | schoolid / classid), data = cl)
# run model
lme5 <- lmer(mathgain ~ mathkind + ses + ses_sch + ses_cls + mk_sch + mk_cls +
(1 | schoolid / classid), data = cl_new)
str(cl_new)
# log likelihood
logLik(lme5)
unique(cl$classid)
cl %>% group_by(schoolid, classid) %>% print(n = 40)
cl %>% group_by(schoolid, classid) %>% select(schoolid, classid) %>% distinct() %>% print(n = 40)
cl %>% group_by(schoolid, classid) %>% select(schoolid, classid) %>% distinct() %>% arrange(schoolid, classid) %>% print(n = 40)
cl %>% group_by(schoolid, classid) %>% select(schoolid, classid) %>% distinct() %>% arrange(schoolid, classid) %>% n()
cl %>% group_by(schoolid, classid) %>% select(schoolid, classid) %>% distinct() %>% select(classid) %>% summarise(n())
cl %>% group_by(schoolid, classid) %>% select(schoolid, classid) %>% distinct() %>% select(classid) %>% dim
312/107
cl %>% group_by(schoolid, classid) %>% select(schoolid, classid) %>% distinct()
cl %>% group_by(schoolid, classid) %>% summarise(class_n = n_distinct(classid))
cl %>% group_by(schoolid, classid) %>% summarise(class_per_sch = n(), class_n = n_distinct(classid))
cl %>% group_by(schoolid, classid) %>% summarise(class_n = n())
cl %>% group_by(schoolid, classid) %>% summarise(class_n = n(schoolid))
cl %>% group_by(schoolid, classid) %>% summarise(class_n = count(schoolid))
cl %>% group_by(schoolid, classid)
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid)
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% summarise(count(schoolid))
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% summarise(n))
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% summarise(n())
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(n())
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n())
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n()) %>% arrange(cnt)
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n()) %>% arrange(desc(cnt))
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n()) %>% mean
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n()) %>% select(cnt) %>% mean
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n()) %>% select(cnt) %>% summarise(mean)
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n()) %>% select(cnt) %>% summarise(mean(cnt))
312 / 107
cl %>% group_by(schoolid, classid) %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n())
cl %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n())
cl %>% distinct(schoolid, classid) %>% select(schoolid) %>% summarise(cnt = n())
cl %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n())
cl %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n()) %>% select(cnt)
hist(cl %>% distinct(schoolid, classid) %>% group_by(schoolid) %>% summarise(cnt = n()) %>% select(cnt))
# model fit
summary(lme5)
summary(lme5)
lme2$
lme2
attributes(lme2)
lme2$class
lme2
library(foreign)
library(lme4)
library(lmerTest)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 60),
tidy = TRUE, warning = FALSE)
# load data
cl <- read.dta("classroom.dta")
# convert IDs to factor
cols_factor <- c("classid", "schoolid", "childid")
cl[cols_factor] <- lapply(cl[cols_factor], factor)
# unconditional means model
lme1 <- lmer(mathgain ~ (1 | schoolid), data = cl)
# log likelihood
logLik(lme1)
summary(lme1)
lme2 <- lmer(mathgain ~ (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme2)
summary(lme2)
lme3 <- lmer(mathgain ~ mathkind + (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme3)
# model fit
summary(lme3)
lme4 <- lmer(mathgain ~ mathkind + ses + (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme4)
# model fit
summary(lme4)
# add variables
ses_sch <- cl %>% group_by(schoolid) %>% summarise(ses_sch = mean(ses))
ses_cls <- cl %>% group_by(schoolid, classid) %>% summarise(ses_cls = mean(ses))
mk_sch <- cl %>% group_by(schoolid) %>% summarise(mk_sch = mean(mathkind))
mk_cls <- cl %>%
group_by(schoolid, classid) %>%
summarise(mk_cls = mean(mathkind))
# add columns to main data
cl_new <- cl %>%
inner_join(ses_sch) %>%
inner_join(ses_cls) %>%
inner_join(mk_sch) %>%
inner_join(mk_cls)
# run model
lme5 <- lmer(mathgain ~ mathkind + ses + ses_sch + ses_cls + mk_sch + mk_cls +
(1 | schoolid / classid), data = cl_new)
# log likelihood
logLik(lme5)
# log likelihood
logLik(lme5)
# model fit
summary(lme5)
ls()
rm(list = ls())
ls()
library(foreign)
library(lme4)
library(lmerTest)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 60),
tidy = TRUE, warning = FALSE)
# load data
cl <- read.dta("classroom.dta")
dim(cl)
str(cl)
# convert IDs to factor
cols_factor <- c("classid", "schoolid", "childid")
cols_factor
unique(cl$sex)
unique(cl$minority)
# convert IDs to factor
cols_factor <- c("sex", "minority", "classid", "schoolid", "childid")
cl[cols_factor] <- lapply(cl[cols_factor], factor)
str(cl)
cl["sex"]
# unconditional means model
lme1 <- lmer(mathkind ~ (1 | schoolid), data = cl)
lme1
summary(lme1)
# log likelihood
logLik(lme1)
summary(lme1)
lme2 <- lmer(mathkind ~ (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme2)
summary(lme2)
lme1a <- lmer(mathkind ~ (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme1a)
summary(lme1a)
anova(lme1, lme1a)
?anova
anova(lme1, lme1a)
anova(lme1, lme1a, refit = False)
anova(lme1, lme1a, refit = FALSE)
anova(lme1, lme1a, refit = TRUE)
anova(lme1, lme1a, refit = FALSE)
str(cl)
# generate 1st grade math scores
cl$math1st <- cl$mathkind = cl$mathgain
# generate 1st grade math scores
cl$math1st <- cl$mathkind + cl$mathgain
head(cl)
# model
# unconditional means model
lme2 <- lmer(math1st ~ (1 | schoolid), data = cl)
# log likelihood
logLik(lme2)
lme2a <- lmer(math1st ~ (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme2a)
summary(lme2a)
anova(lme2, lme2a, refit = FALSE)
lme3 <- lmer(math1st ~ ses + sex + minority + (1 | schoolid / classid), data = cl)
logLik(lme3)
lme3 <- lmer(math1st ~ ses + sex + minority + (1 | schoolid), data = cl)
logLik(lme3)
lme3 <- lmer(math1st ~ ses + sex + minority + (1 | schoolid), data = cl)
logLik(lme3)
lme3 <- lmer(math1st ~ ses + sex + minority + (1 | schoolid / classid), data = cl)
logLik(lme3)
lme3 <- lmer(math1st ~ ses + sex + minority + (1 | schoolid), data = cl)
logLik(lme3)
summary(lme3)
lme3a <- lmer(math1st ~ ses + sex + minority + (1 | schoolid), data = cl)
logLik(lme3a)
summary(lme3a)
lme3b <- lmer(math1st ~ ses + sex + minority + (1 | schoolid / classid),
data = cl)
logLik(lme3b)
summary(lme3b)
anova(lme3a, lme3b)
anova(lme3a, lme3b, refit = FALSE)
lmer::anova
colnames(cl)
lme4a <- lmer(math1st ~ ses + sex + minority + yearstea + (1 | schoolid / classid),
data = cl)
logLik(lme4a)
summary(lme4a)
cl$yt_sq <- cl$yearstea^2
cl$yt_cyb <- cl$yearstea^3
head(cl)
head(cl, 20)
12.54^2
12.54^3
lme4d <- lmer(math1st ~ ses + sex + minority + yearstea + yt_sq + yt_cub +
(1 | schoolid / classid),
data = cl)
logLik(lme4d)
lme4d <- lmer(math1st ~ ses + sex + minority + yearstea + yt_sq + yt_cub +
(1 | schoolid / classid),
data = cl)
cl$yt_sq <- cl$yearstea^2
cl$yt_cub <- cl$yearstea^3
lme4d <- lmer(math1st ~ ses + sex + minority + yearstea + yt_sq + yt_cub +
(1 | schoolid / classid),
data = cl)
logLik(lme4d)
summary(lme4d)
anova(lme4a, lme4d)
anova(lme4a, lme4d, refit = FALSE)
hea(cl, 20)
head(cl, 20)
unique(cl$ses)
len(unique(cl$ses))
length(unique(cl$ses))
length(unique(cl$schoolid))
length(unique(cl$classid))
unique(cl$childid)
cl$classid
library(foreign)
library(lme4)
library(lmerTest)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 60),
tidy = TRUE, warning = FALSE)
# load data
cl <- read.dta("classroom.dta")
# convert to factor
cols_factor <- c("sex", "minority", "classid", "schoolid", "childid")
cl[cols_factor] <- lapply(cl[cols_factor], factor)
# unconditional means model
lme1 <- lmer(mathkind ~ (1 | schoolid), data = cl)
# log likelihood
logLik(lme1)
summary(lme1)
lme1a <- lmer(mathkind ~ (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme1a)
summary(lme1a)
anova(lme1, lme1a, refit = FALSE)
# generate 1st grade math scores
cl$math1st <- cl$mathkind + cl$mathgain
# model
# unconditional means model
lme2 <- lmer(math1st ~ (1 | schoolid), data = cl)
# log likelihood
logLik(lme2)
lme2a <- lmer(math1st ~ (1 | schoolid / classid), data = cl)
# log likelihood
logLik(lme2a)
summary(lme2a)
anova(lme2, lme2a, refit = FALSE)
lme3a <- lmer(math1st ~ ses + sex + minority + (1 | schoolid), data = cl)
logLik(lme3a)
summary(lme3a)
lme3b <- lmer(math1st ~ ses + sex + minority + (1 | schoolid / classid),
data = cl)
logLik(lme3b)
summary(lme3b)
anova(lme3a, lme3b, refit = FALSE)
lme4a <- lmer(math1st ~ ses + sex + minority + yearstea + (1 | schoolid / classid),
data = cl)
logLik(lme4a)
summary(lme4a)
cl$yt_sq <- cl$yearstea^2
cl$yt_cub <- cl$yearstea^3
lme4d <- lmer(math1st ~ ses + sex + minority + yearstea + yt_sq + yt_cub +
(1 | schoolid / classid),
data = cl)
logLik(lme4d)
summary(lme4d)
anova(lme4a, lme4d, refit = FALSE)
lme4a <- lmer(math1st ~ ses + sex + minority + yearstea + (1 | schoolid / classid),
data = cl, REML = FALSE)
logLik(lme4a)
lme4a <- lmer(math1st ~ ses + sex + minority + yearstea + (1 | schoolid / classid),
data = cl)
logLik(lme4a)
lme4a <- lmer(math1st ~ ses + sex + minority + yearstea + (1 | schoolid / classid),
data = cl, REML = FALSE)
logLik(lme4a)
```{r}
summary(lme4a)
cl$yt_sq <- cl$yearstea^2
cl$yt_cub <- cl$yearstea^3
lme4d <- lmer(math1st ~ ses + sex + minority + yearstea + yt_sq + yt_cub +
(1 | schoolid / classid),
data = cl,
REML = FALSE)
logLik(lme4d)
lme4d <- lmer(math1st ~ ses + sex + minority + yearstea + yt_sq + yt_cub +
(1 | schoolid / classid),
data = cl)
logLik(lme4d)
lme4d <- lmer(math1st ~ ses + sex + minority + yearstea + yt_sq + yt_cub +
(1 | schoolid / classid),
data = cl,
REML = FALSE)
logLik(lme4d)
summary(lme4d)
anova(lme4a, lme4d, refit = FALSE)
anova(lme4a, lme4d)
anova(lme4a, lme4d, refit = FALSE)
library(foreign)
library(lme4)
library(lmerTest)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 60),
tidy = TRUE, warning = FALSE)
anova(lme1, lme1a, refit = TRUE)
anova(lme1, lme1a, refit = FALSE)
anova(lme2, lme2a, refit = TRUE)
anova(lme2, lme2a, refit = FALSE)
anova(lme3a, lme3b, refit = TRUE)
anova(lme3a, lme3b, refit = FALSE)
rm(list = ls())
ls()
rm(list = ls())
ls()
# not run
setwd("C:/Users/apagta950/Documents/NYU/Courses/Spring 2021/MDML/Final Project/US-News-NLP/analysis")
library(anytime)
library(dplyr)
library(ggplot2)
library(lubridate)
library(readr)
library(tidyr)
library(tidytext)
library(topicmodels)
seed <- 14
# directories
figures_dir <- "../figures/"
data_dir <- "../data/"
articles <- read_csv(paste0(data_dir, "news_model_input.csv"))
dim(articles)
dim(articles)
colnames(articles)
all_news_class <- articles %>%
mutate(text1 = tolower(text),
# new features1
# study by "Politicization and Polarization in COVID-19 News Coverage"
covid19 = grepl(c("corona", "coronavirus","covid"), text1)*1,
scientist = grepl(c('scientist', 'research', 'professor', 'health official', 'doctor','dr', 'health commission','expert', 'health leader', 'health service','health authorit', 'world health organization', 'centers for disease control and prevention', 'cdc', 'national institutes of health', 'health and human services', 'mayo clinic', 'johns hopkins' , 'fauci', 'birx', 'tedros'), text1)*1,
republican = grepl(c("republican","gop", 'conservative', "trump", "pence", "mcconnell","white house","administration"), text1)*1,
democrat = grepl(c("democrat","liberal","progressive","pelosi" ,"schumer", "biden", "obama","newsom" ,"whitmer","cuomo","biden,","sanders"), text1)*1,
# new feature 2
# study name "Polarization in elite communication on the COVID-19 pandemic"
repub_words = grepl(c("coronavirus","china","businesses","realdonaltrump","relief","inittogether","small","together", "cares","great"), text1)*1,
demo_words = grepl(c("health","need","crisis","public","workers","trump","must","pandemic","care","leave","paid","familiesfirst","people","sick","emergency"), text1)*1,
# new feature 3
# research paper by Pew Research Center
div_words1 = grepl(c("social distance","gathering","avoid","large groups"), text1)*1,
div_words2 = grepl(c("limit","carry-out","restaurant","restaurants"), text1)*1,
div_words3 = grepl(c("closing","close","k-12","school"), text1)*1,
div_words4 = grepl(c("race","racial","racism","blm"), text1)*1,
div_words5 = grepl(c("climate","climate change","global warming","global climate change"), text1)*1,
)
colnames(all_news_class)
all_news_class <- articles %>%
mutate(text1 = tolower(text),
# new features1
# study by "Politicization and Polarization in COVID-19 News Coverage"
covid19 = grepl(c("corona", "coronavirus","covid"), text1)*1,
scientist = grepl(c('scientist', 'research', 'professor', 'health official', 'doctor','dr', 'health commission','expert', 'health leader', 'health service','health authorit', 'world health organization', 'centers for disease control and prevention', 'cdc', 'national institutes of health', 'health and human services', 'mayo clinic', 'johns hopkins' , 'fauci', 'birx', 'tedros'), text1)*1,
republican = grepl(c("republican","gop", 'conservative', "trump", "pence", "mcconnell","white house","administration"), text1)*1,
democrat = grepl(c("democrat","liberal","progressive","pelosi" ,"schumer", "biden", "obama","newsom" ,"whitmer","cuomo","biden,","sanders"), text1)*1,
# new feature 2
# study name "Polarization in elite communication on the COVID-19 pandemic"
repub_words = grepl(c("coronavirus","china","businesses","realdonaltrump","relief","inittogether","small","together", "cares","great"), text1)*1,
demo_words = grepl(c("health","need","crisis","public","workers","trump","must","pandemic","care","leave","paid","familiesfirst","people","sick","emergency"), text1)*1,
# new feature 3
# research paper by Pew Research Center
div_words1 = grepl(c("social distance","gathering","avoid","large groups"), text1)*1,
div_words2 = grepl(c("limit","carry-out","restaurant","restaurants"), text1)*1,
div_words3 = grepl(c("closing","close","k-12","school"), text1)*1,
div_words4 = grepl(c("race","racial","racism","blm"), text1)*1,
div_words5 = grepl(c("climate","climate change","global warming","global climate change"), text1)*1,
) %>%
select(-text1)
dim(all_news_class)
colnames(all_news_class)
# write to csv
write_csv(all_news_class, paste0(data_dir, "news_model_input.csv"))
# write to csv
write_csv(all_news_class, paste0(data_dir, "news_model_input.csv"))
